# فلوچارت سامانه تعاونی سهام

این یک فلوچارت ساده از جریان سیستم است.

```mermaid
flowchart TD
    A[شروع: ورود به سامانه] --> B{کاربر کد ملی وارد می‌کند؟}
    B -->|خیر| C[خطا: کد ملی نامعتبر]
    B -->|بله| D[API: /api/start-login]
    D --> E{کاربر ثبت‌شده؟}
    E -->|خیر| F[تولید توکن لینکینگ و لینک به بات Bale]
    F --> G[کاربر شماره موبایل را در بات به اشتراک می‌گذارد]
    G --> H[Webhook: پردازش شماره و ذخیره در Supabase]
    H --> I[ارسال OTP به بات]
    E -->|بله| I
    I --> J[کاربر OTP را وارد می‌کند]
    J --> K[API: /api/verify-otp]
    K --> L{OTP معتبر و پروفایل کامل؟}
    L -->|خیر - OTP نامعتبر| M[خطا: OTP منقضی یا اشتباه]
    L -->|بله - پروفایل کامل| N[ورود به داشبورد]
    L -->|خیر - پروفایل ناقص| O[صفحه تکمیل پروفایل]
    O --> P[API: /api/update-profile]
    P -->|موفق| N
    P -->|خطا| Q[خطا: اطلاعات ناقص]
    N --> R{گزینه کاربر در داشبورد؟}
    R -->|فروش سهام| S[صفحه ثبت پیشنهاد فروش]
    S --> T[API: /api/sale-offers (POST)]
    T -->|موفق| U[ثبت پیشنهاد و بازگشت به داشبورد]
    T -->|خطا - سهم ناکافی| V[خطا: سهم کافی نیست]
    U --> W[مشاهده پیشنهادهای خود: API /api/my-offers]
    W --> X[صفحه مدیریت پیشنهاد: API /api/my-offers/<id>]
    X --> Y{درخواست‌های خرید؟}
    Y -->|خیر| Z[پیام: هیچ درخواستی نیست]
    Y -->|بله| AA[لیست درخواست‌ها]
    AA --> AB{اقدام فروشنده؟}
    AB -->|تایید| AC[API: /api/approve-request]
    AC -->|موفق| AD[بروزرسانی وضعیت، ارسال نوتیفیکیشن به خریدار/فروشنده via بات]
    AB -->|رد| AE[API: /api/reject-request]
    AE -->|موفق| AF[بروزرسانی وضعیت، نوتیفیکیشن به خریدار via بات]
    R -->|خرید سهام| AG[صفحه مشاهده پیشنهادها: API /api/sale-offers (GET)]
    AG --> AH[لیست پیشنهادهای فعال دیگران]
    AH --> AI[جزئیات پیشنهاد: API /api/sale-offers/<id>]
    AI --> AJ[ارسال درخواست خرید]
    AJ --> AK[API: /api/purchase-requests (POST)]
    AK -->|موفق| AL[ثبت درخواست، نوتیفیکیشن به فروشنده via بات]
    AK -->|خطا - تکراری یا غیرفعال| AM[خطا: درخواست نامعتبر]
    AD --> AN[پایان عملیات]
    AF --> AN
    AL --> AN
    C --> AO[پایان با خطا]
    M --> AO
    Q --> AO
    V --> AO
    Z --> AN
    AM --> AO
    AN[پایان: بازگشت به داشبورد یا خروج]
